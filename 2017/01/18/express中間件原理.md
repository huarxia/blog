---
title: expressä¸­é–“ä»¶åŸç†
slug: express-zhong-jian-jian-yuan-li
date_published: 2017-01-18T08:26:15.909Z
date_updated:   2017-01-19T09:27:56.549Z
tags: express
---

æœ‰æ™‚å€™é¢è©¦ï¼Œè€æ˜¯è¢«å•åˆ°ä¸€äº›è‡ªå·±ä½¿ç”¨éçš„æŠ€è¡“ï¼Œä½†æ˜¯åƒ…åƒ…é™æ–¼ä½¿ç”¨ï¼Œé€™å€‹æ˜¯çœŸæ²’æ·±å…¥ç ”ç©¶éï¼Œé„™äººèƒ½åŠ›æœ‰é™çš„ç·£æ•…å§ã€‚ä½†æ˜¯å‘¢ï¼Œæ¯æ¯è¢«å•å€’ä¹‹å¾Œä¸‹ä¾†åˆæœƒæƒ³ç‚ºä»€éº¼ä¸åœ¨æ·±å…¥ä¸€é»å‘¢ï¼Ÿ(é‚ªæƒ¡ğŸ˜ˆä¹‹ç¬‘)~\~;å®Œå…¨å¯ä»¥å†å¤šäº†è§£ä¸€é»å˜›ã€‚

ä¸éæ€éº¼èªªå‘¢ï¼Œé¢è©¦å®˜éœ€è¦çš„æ˜¯ä¸€é¡äººæ‰ï¼Œä»–ä¹Ÿæœƒå•åˆ°æ—ç³»ä¸ç›¸å¹²æˆ–è€…åœ¨æ·±å±¤æ¬¡çš„å•é¡Œï¼Œé€™é»æˆ‘å°±è¦ºå¾—æœ‰é»å¥‡æ€ªäº†ï¼Œç”²æ–¹éœ€è¦çš„èƒ½åŠ›æ»¿è¶³ï¼Œé—œæ–¼å…¶ä»–çš„ä¸æœƒåè€Œæœƒæ¸›åˆ†ï¼Œé›£é“ä¸æ‡‰è©²æ˜¯ï¼Œä¸æœƒä¸è¦ç·Šï¼Œæœ‰æ™‚é–“å¤šå­¸ç¿’å­¸ç¿’å°±å¥½äº†å—ã€‚éè¦æå¾—é›£å€’é¢è©¦è€…æ‰ç”˜å¿ƒã€‚æ—¢ç„¶é€™æ¨£çš„é¢è©¦å®˜å¾ˆå¤šï¼Œæ‰€ä»¥èƒ½å¤šå­¸é»æ˜¯ä¸€é»ï¼Œé«˜æ¨™æº–è¦æ±‚è‡ªå·±ã€‚

é‚£å¤©æ˜¯é˜¿é‡Œçš„é¢è©¦å®˜é›»è©±é¢è©¦çš„ï¼Œä¹Ÿåƒ…é™äºæºé€šï¼Œé¡~\~ï¼Œè¢«é˜¿é‡Œé›»è©±é¢è©¦äº†å¥½å¤šæ¬¡ï¼Œéƒ½æ²’çµæœï¼Œæˆ‘æƒ³èªªçš„æ˜¯é²æ—©æˆ‘éƒ½æœƒé€²ä¾†ï¼Œæµªè²»å¤§å®¶æ™‚é–“å¹¹å˜›ã€‚ 

å‰å¹¾å€‹å•é¡Œé‚„å¥½ï¼Œéƒ½æ˜¯å›ç­”è‡ªå·±æ“…é•·çš„å•é¡Œï¼Œé‚„ç®—OKã€‚æˆ‘çš„ç«™é»æœ‰ä¸€å€‹æ˜¯[èŠ±å¤é›†](http://www.huar.love/hua)ã€‚ä»–æ˜¯çœ‹åˆ°é€™å€‹è¯ç¹«åˆ°æˆ‘çš„ã€‚ä¸€ä¸Šä¾†å°±å•æˆ‘æ˜¯ä¸æ˜¯ `èŠ±å¤é›†` æå¾—æœ‰é»ä¸€é ­éœ§æ°´ã€‚ç„¶å¾Œå°±è§£é‡‹æ˜¯æ€éº¼çœ‹åˆ°æˆ‘çš„ï¼Œæ‰¾åˆ°æˆ‘çš„ã€‚ç¬é–“å¾ˆå¥‡æ€ªåŠ é©šå‹•ã€‚å°ï¼å°±æ˜¯é©šå‹•ã€‚å±…ç„¶æœ‰äººå› ç‚ºçœ‹åˆ°ä¸€å€‹æŠ€è¡“äººå“¡çš„è©©é›†ç«™é»å¾è€Œæ‰“é›»è©±é€²è¡Œé¢è©¦çš„ã€‚å¯èƒ½æ˜¯ç”±æ–¼é€™å€‹ç«™é»æ™‚`nodejs+express+mongodb`åšçš„å§ã€‚äº‹å¯¦è­‰æ˜ç¢ºå¯¦æ˜¯å› ç‚ºé€™æ¨£ï¼Œä»–å€‘å‰›å¥½éœ€è¦`nodejs`æ–¹é¢çš„å·¥ç¨‹å¸«ã€‚

å·´æ‹‰å·´æ‹‰...èŠäº†ä¸€äº›ï¼Œæœ€å¾ŒèŠåˆ°koaä¸­é–“ä»¶ï¼Œé€™å€‹æˆ‘ä¸æœƒï¼Œ`koa`æ²’ç”¨éï¼Œç”¨éexpress.åƒ…é™æ–¼åƒç…§æ–‡æª”åšçš„ï¼Œç„¶å¾Œå°±é–‹å§‹äº†......å°æ–¼expressæ·±å…¥çš„ç¢ºå¯¦ä¸äº†è§£ï¼Œèåˆ°ä¸­é–“ä»¶äº‹ä¸€å•ä¸‰ä¸çŸ¥ï¼ŒåªçŸ¥é“æ€éº¼ç”¨ï¼Œç°¡å–®çš„è‡ªå·±å¯¦ç¾åŸç†éƒ½ä¸æ¸…æ¥šï¼Œæ‰€ä»¥ç¾åœ¨æ‰é–‹å§‹å¯«ä¸€ç¯‡æ–‡ç« ä¾†èªªæ˜ä¸‹ã€‚ä¹Ÿæ˜¯çœ‹äº†ç¶²ä¸Šçš„æ–‡ç« è§£é‡‹ï¼Œæœ‰äº†é€²ä¸€æ­¥çš„äº†è§£ã€‚

å»¢è©±äº†é€™éº¼å¤šï¼Œé€²å…¥æ­£é¡Œï¼š`express`ä¸­é–“ä»¶åŸç†ç°¡å–®å‰–æ

å­¸`express`é¦–å…ˆå¾—æœƒé»`nodejs`å§ï¼Œå…ˆä¾†ä¸€æ®µ`nodejs`æœ€åŸºç¤çš„`hello world`

```
var http = require('http');
http.createServer(function (req, res) {
    res.writeHead(200, {'Content-Type': 'text/plain'});
    res.end('Hello World\n');
}).listen(1337, '127.0.0.1');

```

ä¸Šé¢è¿™æ®µä»£ç æ¥è‡ª`nodejs`çš„å®˜ç½‘ï¼Œéå¸¸ç®€å•ï¼Œå°±æ˜¯æ¥ä¸€ä¸ªè¯·æ±‚ï¼Œå°±ç”¨ä¼ ç»™`createServer`çš„åŒ¿åå‡½æ•°æ¥å¤„ç†è¯·æ±‚ã€‚

ç¹¼çºŒçœ‹çœ‹`Express`çš„ä»£ç 

```
var app = express();
//...ä¸­é—´å¿½ç•¥
http.createServer(app).listen(app.get('port'), function(){
    console.log('Express server listening on port ' + app.get('port'));
});

```

å¯¹æ¯”å¯ä»¥çœ‹å‡ºï¼Œæ‰§è¡Œexpress()åï¼Œä¼šè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œèµ‹å€¼ç»™appï¼Œappæ‡‰è©²æ˜¯ï¼š

```
function(req,res){//...}
```

ç„¶åè¯·æ±‚éƒ½ä¼šè¢«appè¿™ä¸ªå‡½æ•°å¤„ç†ï¼ˆå› ä¸ºè¿™ä¸ªappæ˜¯æ‰§è¡Œexpressåçš„ç»“æœï¼‰

å¯ä»¥è®¤ä¸ºï¼Œåœ¨`express`å†…éƒ¨ï¼Œæœ‰ä¸€ä¸ªå‡½æ•°çš„æ•°ç»„ï¼Œæš‚æ—¶å«è¿™ä¸ªæ•°ç»„tasksï¼Œæ¯æ¥ä¸€ä¸ªè¯·æ±‚`express`å†…éƒ¨ä¼šä¾æ¬¡æ‰§è¡Œè¿™ä¸ªæ•°ç»„ä¸­çš„å‡½æ•°ï¼ˆè¿™é‡Œè¯´ä¾æ¬¡å¹¶ä¸ä¸¥è°¨ï¼Œæ¯ä¸ªå‡½æ•°å¿…é¡»æ»¡è¶³ä¸€å®šæ¡ä»¶æ‰è¡Œï¼Œè¿™ä¸ªåé¢è¯´ï¼‰ï¼Œåº”è¯¥å¯ä»¥æƒ³åˆ°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°æ•°ç»„é‡Œï¼Œæ¯ä¸ªå‡½æ•°çš„ç­¾ååº”è¯¥åƒä¸‹é¢é‚£æ ·å¯¦éš›ä¸Šé€™å€‹å°±æ˜¯ä¸­é–“ä»¶çš„ç²¾é«“æ‰€åœ¨...å™“ï¼

```
function(req, res){//...}
```

å¯¦éš›ä¸Šæ‡‰è©²æ˜¯ï¼š

```
function(req, res, next){//...}
```

è¿™é‡Œçš„`next`ï¼Œæ˜¯æŒ‡ä¸‹ä¸€ä¸ªå‡½æ•°ã€‚åé¢æˆ‘ä»¬ä¼šå†™ä¸€äº›è¯•éªŒæ¥ä½“éªŒä¸€ä¸‹è¿™ä¸ª`next`.


> 1.å¯¼å…¥ç›¸å…³æ¨¡å—

> 2.æ‰§è¡Œè¿‡ `var app = express()` åï¼Œä½¿ç”¨`app.set` è®¾ç½®`express`å†…éƒ¨çš„ä¸€äº›å‚æ•°ï¼ˆoptionsï¼‰ä½¿ç”¨`app.use` æ¥æ³¨å†Œå‡½æ•°ï¼Œå¯ä»¥ç®€å•çš„è®¤ä¸ºæ˜¯å‘é‚£ä¸ª`tasks`çš„æ•°ç»„è¿›è¡Œ`push`æ“ä½œ

> 3.é€šè¿‡`http.createServer` ç”¨appæ¥å¤„ç†è¯·æ±‚


#### è¯•éªŒ1. å‘expressä¸­æ³¨å†Œè‡ªå®šä¹‰å‡½æ•°

æ³¨å†Œè¿›expressä¸­çš„å‡½æ•°:

> 1. é•¿æˆä¸‹é¢è¿™ä¸ªæ ·å­

```
function(req, res, next){
    //...æˆ‘ä»¬è‡ªå·±çš„é€»è¾‘
    next();
}

```

æˆ–è€…ï¼š

```
app.use(function(err,req,res,next){
    if(err){
        //è‡ªå·±çš„å¤„ç†é”™è¯¯çš„é€»è¾‘
        console.log(err.message);
        console.log(err.stack);
        res.end('404')  
    }
});
```

> 2. `app.use(customerFunc)` è¦å†™åœ¨ä¸‹é¢ä¸¤å¥çš„å‰é¢

```
app.use(app.router);
app.use(express.static(path.join(__dirname, 'public')));

```
ä¸€èˆ¬æƒ…æ³ä¸‹æ˜¯é€™éº¼ä½¿ç”¨çš„ï¼Œä½†æ˜¯å°æ–¼é€šç”¨`error`è™•ç†å¯ä»¥æ”¾åˆ°æœ€å¾Œï¼Œ`http.createServer`ä¹‹å‰

```
app.use(express.static(path.join(__dirname, '/web/dist')));
// catch 404 and forwarding to error handler
app.use(function(req, res, next) {
    var err = new Error('Not Found');
    err.status = 404;
    next(err);
});
// å¯åŠ¨åŠç«¯å£
http.createServer(app).listen(app.get('port'), function(req, res){
    console.log('å¯åŠ¨æˆåŠŸï¼Œç«¯å£ä¸º' + app.get('port'));
    console.log('ä¸»é¡µåœ°å€ï¼šhttp://localhost:' + app.get('port'));
});
```

å…³äºç¬¬2ç‚¹ï¼Œæ˜¯å› ä¸ºè·¯ç”±åæˆ–è¯·æ±‚é™æ€èµ„æºåï¼Œä¸€æ¬¡è¯·æ±‚å“åº”çš„ç”Ÿå‘½å‘¨æœŸå®è´¨ä¸Šå·²ç»ç»“æŸï¼ŒåŠ åœ¨è¿™åé¢è¿›è¡Œè¯·æ±‚å¤„ç†ï¼Œæ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚

å…³äºç¬¬1ç‚¹ï¼Œå†™ç‚¹ä»£ç ç¹¼çºŒé€²è¡Œè©¦é©—ï¼š

```
app.use(function(req,res,next){
    console.log("111");
    next();
});

```

å¦‚æœä¸å†™`next()`,é‚£ä¹ˆåé¢æ³¨å†Œçš„å‡½æ•°å°±ä¸ä¼šæ‰§è¡Œ(ä¸€å€‹å¤§è‡‰ç–‘å•)ï¼Œè¿è¡Œæ¸¬è©¦ä¸‹ä¸å°±çŸ¥é“äº†

```
app.use(function(req,res,next){
    console.log('111');
    next();
    console.log('222');
});

app.use(function(req,res,next){
    console.log("333");
    next();
});
```

é‚£ä¹ˆæ§åˆ¶å°çš„è¾“å‡ºçš„é¡ºåºæ˜¯ï¼š`111 333 222`

#### è¯•éªŒäºŒ next()çš„å·¥ä½œåŸç†

æ•´ä¸ªå¤„ç†è¯·æ±‚çš„æ¨¡å‹è¿˜æ˜¯æ¯”è¼ƒç®€å•çš„ï¼Œåœ¨ç†è§£çš„ä¸Šé¢çš„è¿‡ç¨‹åï¼Œèƒ½ä¸èƒ½ä¸å€ŸåŠ©`express`ï¼Œè‡ªå·±å®ç°ä¸Šé¢çš„è¿‡ç¨‹å‘¢ï¼Œä¸»è¦æ˜¯æ€ä¹ˆå¤„ç†`next()`é‚£ä¸€å—

```
var http = require('http');
function express(){
    var funcs = [];

    var expr = function(req,res){
        var i = 0;
        function next(){            
            var task = funcs[i++];
            if(!task) return;
            task(req,res,next);
        }
        next();
    }
    expr.use=function(f){
        funcs.push(f);
    }
    return expr;
}
var app = express();

app.use(function(req,res,next){
    console.log('haha');
    next();
});
app.use(function(req,res,next){
    console.log('hehe');
    next();
});
app.use(function(req,res){
    res.end("there is nothing happened");
});

http.createServer(app).listen('3000', function(){
  console.log('Express server listening on port 3000');
});

```

å¯åŠ¨æœåŠ¡åï¼Œæ¯æ¥ä¸€ä¸ªè¯·æ±‚ï¼Œæ§åˆ¶å°ä¼šä¾æ¬¡è¾“å‡º`haha hehe`ï¼Œç„¶åæµè§ˆå™¨æ˜¯`there is nothing happened`

å½“ç„¶å¦‚æœè¦æ›´æ·±ä¸€æ­¥äº†è§£åˆ°ï¼Œå¯ä»¥å»çœ‹æºä»£ç ï¼Œå®é™…ä¸Šè¿™ä¸€éƒ¨åˆ†çš„ä¸»è¦ä»£ç æ˜¯åœ¨`connect`ä¸­çš„ï¼Œåœ¨`connect/lib/proto.js` è¿™ä¸ªæºæ–‡ä»¶ä¸­ï¼Œä¸»è¦æ˜¯`app.use`,å’Œ`app.handle` ä¸¤ä¸ªå‡½æ•°ä¸­

å¾ŒçºŒæœƒå†æ¬¡ç ”ç©¶`express`çš„`app.use`åŸç†ã€‚

åƒè€ƒåŸæ–‡ä¾†è‡ª [å‰ç«¯äº‚ç‡‰](http://www.html-js.com)

